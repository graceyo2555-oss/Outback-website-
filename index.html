<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TonFi Treasury Tracker</title>
<meta name="description" content="TonFi â€” simple TON wallet & jetton tracker with live USD pricing from STON.fi & DeDust." />
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'><text y='.9em' font-size='90'>ðŸ’Ž</text></svg>">

<style>
  :root{
    --bg:#071023; --card:#0c172f; --muted:#8aa0c4; --text:#e8f1ff; --accent:#2fb9ff; --accent2:#14b8ff; --good:#00d084; --warn:#ffb020; --bad:#ff5470; --border:rgba(255,255,255,.08);
    --glass: rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    color:var(--text);
    background:
      radial-gradient(1000px 600px at 20% -10%, #183d7a55, transparent 60%),
      radial-gradient(800px 500px at 100% 0%, #0e2e5e66, transparent 60%),
      var(--bg);
  }
  .wrap{max-width:1120px; margin:0 auto; padding:28px 16px 56px}
  header{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:18px}
  .brand{display:flex; align-items:center; gap:12px}
  .logo{width:32px; height:32px; border-radius:50%; background:linear-gradient(180deg,#1e90ff,#1266d1)}
  .brand h1{font-size:22px; font-weight:800; margin:0; letter-spacing:.2px}
  .tag{padding:4px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}
  .panel{background:var(--card); border:1px solid var(--border); border-radius:18px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .grid{display:grid; gap:12px}
  @media(min-width:900px){ .grid-3{grid-template-columns: 1.2fr .8fr 1fr} }
  @media(min-width:900px){ .grid-2{grid-template-columns: 1fr 1fr} }
  .controls{display:flex; gap:10px; flex-wrap:wrap}
  input[type="text"]{
    flex:1 1 320px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0f1b35; color:var(--text);
    outline:none; transition:.2s border;
  }
  input[type="text"]::placeholder{color:#6f86ad}
  button{
    padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:#0f1b35; color:var(--text); cursor:pointer; font-weight:700;
  }
  button.primary{
    background:linear-gradient(180deg, var(--accent), var(--accent2)); border:none; color:#001326;
    box-shadow:0 8px 22px rgba(47,185,255,.35);
  }
  button.ghost{background:transparent}
  .note{color:var(--muted); font-size:12px}
  .kpi{display:flex; flex-direction:column; gap:6px; padding:14px; border:1px dashed var(--border); border-radius:14px; background:linear-gradient(0deg, transparent, var(--glass))}
  .kpi .label{color:var(--muted); font-size:12px}
  .kpi .value{font-size:22px; font-weight:800}
  .kpi .sub{color:var(--muted); font-size:12px}
  .table{width:100%; border-collapse:collapse; margin-top:6px; font-size:14px}
  .table th, .table td{padding:10px 8px; border-bottom:1px solid var(--border)}
  .table th{color:#93add1; font-weight:700; text-align:left; font-size:12px}
  .right{text-align:right}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .pill{padding:2px 8px; border-radius:999px; background:#0d1f3b; border:1px solid var(--border); color:#a8c2ea; font-size:12px; display:inline-flex; align-items:center; gap:6px}
  .status{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
  .footer{margin-top:18px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  a{color:var(--accent); text-decoration:none}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .warn{color:var(--warn)}
  .good{color:var(--good)}
  .chip{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0e1d37; color:#a8c2ea; font-size:12px}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="tonfi-logo.png" alt="TonFi" class="logo" onerror="this.style.display='none'; document.getElementById('brandText').style.display='block'">
        <div id="brandText" style="display:none; font-weight:800; font-size:18px; letter-spacing:.2px">TonFi</div>
        <h1>Treasurey Tracker</h1>
        <span class="tag">alpha â€¢ client-side</span>
      </div>
      <div class="status" id="status"><span>Ready.</span></div>
    </header>

    <div class="panel">
      <div class="controls">
        <input id="addr" type="text" spellcheck="false" placeholder="Enter TON wallet address (e.g. EQC...)" />
        <button class="ghost" id="pasteBtn">Paste</button>
        <button class="ghost" id="exampleBtn">Use Example</button>
        <button class="primary" id="loadBtn">Load</button>
      </div>
      <div class="note" style="margin-top:8px">
        Tip: Set <span class="mono">DEFAULT_ADDRESS</span> in the code or open with <span class="mono">?addr=EQxxxx</span>. Last address auto-saves.
      </div>
      <div class="chips" style="margin-top:10px">
        <!-- Preset quick buttons: edit these to your wallets -->
        <button class="chip" data-addr="">Treasury</button>
        <button class="chip" data-addr="">Marketing</button>
        <button class="chip" data-addr="">Ops</button>
      </div>
    </div>

    <div class="grid grid-3" style="margin-top:12px">
      <div class="panel">
        <div class="kpi">
          <div class="label">Total Portfolio Value</div>
          <div class="value" id="totalUsd">$0.00</div>
          <div class="sub" id="totalBreakdown">TON $0.00 â€¢ Jettons $0.00</div>
        </div>
      </div>
      <div class="panel">
        <div class="kpi">
          <div class="label">TON Balance</div>
          <div class="value" id="tonBal">0</div>
          <div class="sub" id="tonUsdSub">$0.00 (at $â€”/TON)</div>
        </div>
      </div>
      <div class="panel">
        <div class="kpi">
          <div class="label">Jettons Tracked</div>
          <div class="value" id="jetCount">0</div>
          <div class="sub">Prices via STON.fi / DeDust (fallback: DexScreener, GeckoTerminal)</div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap">
        <h2 style="font-size:16px; margin:0">Jettons</h2>
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
          <div class="pill"><span>Filter:</span>
            <select id="filterSel" style="background:transparent; color:#a8c2ea; border:none; outline:none">
              <option value="all">All</option>
              <option value="priced">With price</option>
              <option value="unpriced">No price</option>
              <option value="nonzero">Non-zero balance</option>
            </select>
          </div>
        </div>
      </div>
      <table class="table" id="jetTable">
        <thead>
          <tr>
            <th>Token</th>
            <th class="right">Balance</th>
            <th class="right">Price (USD)</th>
            <th class="right">Value (USD)</th>
          </tr>
        </thead>
        <tbody id="jetBody">
          <tr><td colspan="4" class="muted">No data yet.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="footer">
      <div class="muted">Data from TonAPI, STON.fi, DeDust, DexScreener, GeckoTerminal. Prices may be missing for new/illiquid tokens.</div>
      <div class="muted">Â© TonFi</div>
    </div>
  </div>

<script>
/** ================================
 *  BASIC SETTINGS (edit these)
 *  ================================ */
const DEFAULT_ADDRESS = ""; // â† put your treasury wallet here (e.g., "EQBDc5nG...")
const TONAPI_BASE = "https://tonapi.io";
const TON_DECIMALS = 9;

/** Rate limits & courtesy timeout between token price fetches */
const PRICE_FETCH_DELAY_MS = 120; // be gentle to APIs

/** Helpers */
const $ = (id)=>document.getElementById(id);
const fmt = (n, d=2) => {
  if (n === null || n === undefined || isNaN(n)) return "â€”";
  const v = Number(n);
  if (Math.abs(v) >= 1000000) return v.toLocaleString(undefined,{maximumFractionDigits:d});
  return v.toLocaleString(undefined,{minimumFractionDigits: (v>0 && v<1 ? Math.min(4,d+2):0), maximumFractionDigits:d});
};
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
const sym = s => (s||"").toUpperCase();

/** UI elements */
const addrInput = $("addr");
const statusEl = $("status");
const totalUsdEl = $("totalUsd");
const totalBreakdownEl = $("totalBreakdown");
const tonBalEl = $("tonBal");
const tonUsdSubEl = $("tonUsdSub");
const jetCountEl = $("jetCount");
const jetBody = $("jetBody");
const filterSel = $("filterSel");

/** Event wiring */
document.querySelectorAll(".chip").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const a = btn.getAttribute("data-addr");
    if (a){ addrInput.value = a; saveLastAddr(a); loadAll(); }
  });
});
$("pasteBtn").onclick = async ()=>{
  try{
    const t = await navigator.clipboard.readText();
    if (t) { addrInput.value = t.trim(); saveLastAddr(t.trim()); }
  }catch(e){ notify("Clipboard blocked by browser.", "warn"); }
};
$("exampleBtn").onclick = ()=>{
  const d = "EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c"; // dummy; replace with real wallet for demo
  addrInput.value = d; saveLastAddr(d);
};
$("loadBtn").onclick = ()=> { const a = addrInput.value.trim(); saveLastAddr(a); loadAll(); };
filterSel.onchange = ()=> applyFilter();

/** Notify helper */
function notify(msg, level=""){ statusEl.innerHTML = `<span class="${level}">${msg}</span>`; }

/** Last address persistence */
function saveLastAddr(a){ try{ if(a && a.length>10) localStorage.setItem("tonfi_last_addr", a); }catch{} }
function getSavedAddr(){ try{ return localStorage.getItem("tonfi_last_addr") || ""; }catch{ return ""; } }

/** Read ?addr= from URL */
function getAddrFromQuery(){
  try{
    const u = new URL(window.location.href);
    return (u.searchParams.get("addr")||"").trim();
  }catch{ return ""; }
}

/** ==== API fetchers ==== */

/** Try fetch with optional simple CORS fallback */
async function safeFetchJSON(url, opts={}){
  try {
    const r = await fetch(url, opts);
    if (!r.ok) return null;
    return await r.json();
  } catch(e){
    // tiny CORS fallback proxy â€” avoid heavy use
    try {
      const proxied = `https://cors.isomorphic-git.org/${url}`;
      const r2 = await fetch(proxied, opts);
      if (!r2.ok) return null;
      return await r2.json();
    } catch(e2){
      return null;
    }
  }
}

/** TON price in USD (CoinGecko Simple Price) */
async function getTonPriceUSD(){
  const cgUrl = `https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd`;
  const j = await safeFetchJSON(cgUrl);
  const v = j?.["the-open-network"]?.usd;
  return (v && isFinite(v)) ? Number(v) : null;
}

/** Get TON (native) balance for account (in TON) */
async function getTonBalance(address){
  const url = `${TONAPI_BASE}/v2/accounts/${address}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`TonAPI account: ${r.status}`);
  const j = await r.json();
  const ton = (j.balance ?? 0) / (10 ** TON_DECIMALS);
  return ton;
}

/** Get Jetton balances (array) */
async function getJettonBalances(address){
  const url = `${TONAPI_BASE}/v2/accounts/${address}/jettons?limit=500`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`TonAPI jettons: ${r.status}`);
  const j = await r.json();
  const out = (j.balances || []).map(x=>{
    const d = x.jetton || {};
    const dec = Number(d.decimals ?? 9);
    return {
      address: (d.address || "").trim(),
      name: d.name || "Unknown",
      symbol: d.symbol || "???",
      decimals: dec,
      image: d.image,
      rawBalance: Number(x.balance || 0),
      balance: Number(x.balance || 0) / (10 ** dec),
      priceUsd: null,
      valueUsd: null
    };
  });
  return out;
}

/** ============================
 *  PRICING (STON.fi / DeDust)
 *  ============================ */

/** Generic ranker: pick item with highest USD liquidity/TVL */
function bestByUsdLiquidity(items, getUsd){
  if (!Array.isArray(items) || !items.length) return null;
  return items
    .map((x,i)=>({i,usd: Number(getUsd(x) ?? 0)}))
    .sort((a,b)=> b.usd - a.usd)[0];
}

/** Extract convenient shape from a STON.fi pool object */
function parseStonPool(p){
  return {
    t0: {symbol: p?.token0?.symbol || p?.token0?.name || "", addr:(p?.token0?.address||""), decimals: Number(p?.token0?.decimals ?? 9)},
    t1: {symbol: p?.token1?.symbol || p?.token1?.name || "", addr:(p?.token1?.address||""), decimals: Number(p?.token1?.decimals ?? 9)},
    r0: Number(p?.reserve0 ?? p?.reserves0 ?? 0),
    r1: Number(p?.reserve1 ?? p?.reserves1 ?? 0),
    tvl: Number(p?.tvl_usd ?? p?.tvlUSD ?? p?.liquidity_usd ?? p?.liquidityUSD ?? 0)
  };
}

/** Extract convenient shape from a DeDust pool object */
function parseDeDustPool(p){
  return {
    t0: {symbol: p?.token0?.symbol || p?.token0?.name || "", addr:(p?.token0?.address||""), decimals: Number(p?.token0?.decimals ?? 9)},
    t1: {symbol: p?.token1?.symbol || p?.token1?.name || "", addr:(p?.token1?.address||""), decimals: Number(p?.token1?.decimals ?? 9)},
    r0: Number(p?.reserve0 ?? p?.reserves0 ?? 0),
    r1: Number(p?.reserve1 ?? p?.reserves1 ?? 0),
    tvl: Number(p?.tvl_usd ?? p?.tvlUSD ?? p?.liquidity_usd ?? p?.liquidityUSD ?? 0)
  };
}

/** Compute token price in USD from a pool against TON or USDT */
function priceFromPoolUSD(pool, jettonAddr, tonUsd){
  const A = pool.t0, B = pool.t1;
  const jet0 = (A.addr||"").toLowerCase() === (jettonAddr||"").toLowerCase();
  const jet1 = (B.addr||"").toLowerCase() === (jettonAddr||"").toLowerCase();
  if (!jet0 && !jet1) return null;

  // normalized reserves
  const r0 = pool.r0 / (10 ** Number(A.decimals||9));
  const r1 = pool.r1 / (10 ** Number(B.decimals||9));

  const s0 = sym(A.symbol), s1 = sym(B.symbol);
  const otherIsTON  = s0.includes("TON") || s1.includes("TON");
  const otherIsUSDT = s0.includes("USDT") || s1.includes("USDT") || s0.includes("USDâ‚®") || s1.includes("USDâ‚®");

  // price in "other token"
  let priceInOther = null;
  if (jet0) priceInOther = r1 / r0; else if (jet1) priceInOther = r0 / r1;
  if (priceInOther==null || !isFinite(priceInOther) || priceInOther<=0) return null;

  if (otherIsTON) {
    if (!tonUsd) return null;
    return priceInOther * tonUsd;
  }
  if (otherIsUSDT) {
    // assume 1 USDT â‰ˆ $1
    return priceInOther * 1.0;
  }
  return null; // unsupported pair here (could extend to USDC, etc.)
}

/** --- STON.fi direct pricing --- */
async function getPriceFromStonfi(jettonAddr, tokenDecimals){
  try{
    // Attempt #1: /v1/pools/by-token
    const byTokenURL = `https://api.ston.fi/v1/pools/by-token?address=${encodeURIComponent(jettonAddr)}`;
    let res = await safeFetchJSON(byTokenURL, { headers:{ "accept":"application/json" }});

    // Attempt #2: fallback variant some gateways expose
    if (!res || (!Array.isArray(res?.pools) && !Array.isArray(res))) {
      const altURL = `https://api.ston.fi/v1/pools?limit=200&jetton_address=${encodeURIComponent(jettonAddr)}`;
      res = await safeFetchJSON(altURL, { headers:{ "accept":"application/json" }});
    }
    const poolsRaw = Array.isArray(res?.pools) ? res.pools : Array.isArray(res) ? res : [];
    if (!poolsRaw.length) return null;

    const pools = poolsRaw.map(parseStonPool);

    // Prefer TON or USDT pools
    const filtered = pools.filter(p=>{
      const s0 = sym(p.t0.symbol), s1 = sym(p.t1.symbol);
      return s0.includes("TON") || s1.includes("TON") || s0.includes("USDT") || s1.includes("USDT");
    });
    const usePools = filtered.length ? filtered : pools;

    // Choose best by TVL (or estimate)
    const tonUsd = await getTonPriceUSD();
    const pick = bestByUsdLiquidity(usePools, (p)=>{
      if (p.tvl) return p.tvl;
      // cheap estimate: if TON is in pool, use TON side * tonUsd * 2
      const s0 = sym(p.t0.symbol), s1 = sym(p.t1.symbol);
      if (s0.includes("TON")) return (p.r0/(10**9)) * (tonUsd||0) * 2;
      if (s1.includes("TON")) return (p.r1/(10**9)) * (tonUsd||0) * 2;
      return 0;
    });
    if (!pick) return null;
    const best = usePools[pick.i];

    return priceFromPoolUSD(best, jettonAddr, await getTonPriceUSD());
  }catch{ return null; }
}

/** --- DeDust direct pricing --- */
async function getPriceFromDeDust(jettonAddr, tokenDecimals){
  try{
    // Attempt #1: /v2/pools/by-token
    const byTokenURL = `https://api.dedust.io/v2/pools/by-token?address=${encodeURIComponent(jettonAddr)}`;
    let res = await safeFetchJSON(byTokenURL, { headers:{ "accept":"application/json" }});

    // Attempt #2: broader list
    if (!res || (!Array.isArray(res?.pools) && !Array.isArray(res))) {
      const allURL = `https://api.dedust.io/v2/pools?limit=200&jetton_address=${encodeURIComponent(jettonAddr)}`;
      res = await safeFetchJSON(allURL, { headers:{ "accept":"application/json" }});
    }
    const poolsRaw = Array.isArray(res?.pools) ? res.pools : Array.isArray(res) ? res : [];
    if (!poolsRaw.length) return null;

    const pools = poolsRaw.map(parseDeDustPool);

    // Prefer TON or USDT pools
    const filtered = pools.filter(p=>{
      const s0 = sym(p.t0.symbol), s1 = sym(p.t1.symbol);
      return s0.includes("TON") || s1.includes("TON") || s0.includes("USDT") || s1.includes("USDT");
    });
    const usePools = filtered.length ? filtered : pools;

    // Choose best by TVL
    const tonUsd = await getTonPriceUSD();
    const pick = bestByUsdLiquidity(usePools, (p)=>{
      if (p.tvl) return p.tvl;
      const s0 = sym(p.t0.symbol), s1 = sym(p.t1.symbol);
      if (s0.includes("TON")) return (p.r0/(10**9)) * (tonUsd||0) * 2;
      if (s1.includes("TON")) return (p.r1/(10**9)) * (tonUsd||0) * 2;
      return 0;
    });
    if (!pick) return null;
    const best = usePools[pick.i];

    return priceFromPoolUSD(best, jettonAddr, await getTonPriceUSD());
  }catch{ return null; }
}

/** --- DexScreener & GeckoTerminal fallbacks --- */
async function getPriceFromDexScreener(jettonAddress){
  const dsUrl = `https://api.dexscreener.com/latest/dex/tokens/${encodeURIComponent(jettonAddress)}`;
  const ds = await safeFetchJSON(dsUrl, { headers:{ "accept":"application/json" }});
  if (ds?.pairs?.length){
    const best = ds.pairs
      .map((p,i)=>({i,usd:Number(p?.liquidity?.usd ?? 0)}))
      .sort((a,b)=> b.usd - a.usd)[0];
    if (best){
      const p = ds.pairs[best.i];
      if (p?.priceUsd && isFinite(p.priceUsd)) return Number(p.priceUsd);
    }
  }
  return null;
}
async function getPriceFromGeckoTerminal(jettonAddress){
  const gtUrl = `https://api.geckoterminal.com/api/v2/networks/ton/tokens/${encodeURIComponent(jettonAddress)}?include=top_pools`;
  const gt = await safeFetchJSON(gtUrl, { headers:{ "accept":"application/json" }});
  const price = gt?.data?.attributes?.price_usd;
  return (price && isFinite(price)) ? Number(price) : null;
}

/** Main: multi-source price resolver */
async function getJettonPriceUSD(jettonAddress, tokenDecimals=9){
  const ston = await getPriceFromStonfi(jettonAddress, tokenDecimals);
  if (ston != null) return ston;

  const dedust = await getPriceFromDeDust(jettonAddress, tokenDecimals);
  if (dedust != null) return dedust;

  const ds = await getPriceFromDexScreener(jettonAddress);
  if (ds != null) return ds;

  const gt = await getPriceFromGeckoTerminal(jettonAddress);
  if (gt != null) return gt;

  return null;
}

/** ==== Renderers ==== */

function renderJettons(rows){
  if (!rows || rows.length===0){
    jetBody.innerHTML = `<tr><td colspan="4" class="muted">No jettons found for this wallet.</td></tr>`;
    return;
  }
  const html = rows.map(t=>{
    const img = t.image ? `<img src="${t.image}" alt="" style="width:18px;height:18px;border-radius:50%;vertical-align:-4px;margin-right:6px">` : "";
    const priceTxt = (t.priceUsd==null ? `<span class="muted">â€”</span>` : `$${fmt(t.priceUsd, 6)}`);
    const valTxt = (t.valueUsd==null ? `<span class="muted">â€”</span>` : `$${fmt(t.valueUsd, 2)}`);
    return `<tr data-priced="${t.priceUsd!=null}" data-nonzero="${t.balance>0}">
      <td>${img}<span class="mono" title="${t.address}">${t.symbol}</span> <span class="muted">Â· ${t.name}</span></td>
      <td class="right mono" title="${t.rawBalance} raw">${fmt(t.balance, 6)}</td>
      <td class="right">${priceTxt}</td>
      <td class="right">${valTxt}</td>
    </tr>`;
  }).join("");
  jetBody.innerHTML = html;
  applyFilter();
}

function applyFilter(){
  const mode = filterSel.value;
  [...jetBody.querySelectorAll("tr")].forEach(tr=>{
    let show = true;
    const priced = tr.getAttribute("data-priced")==="true";
    const nonzero = tr.getAttribute("data-nonzero")==="true";
    if (mode==="priced" && !priced) show=false;
    if (mode==="unpriced" && priced) show=false;
    if (mode==="nonzero" && !nonzero) show=false;
    tr.style.display = show ? "" : "none";
  });
}

/** ==== Controller ==== */

async function loadAll(){
  const address = addrInput.value.trim();
  if (!address || address.length < 10){
    notify("Enter a valid TON wallet address.", "warn");
    return;
  }
  notify("Loading balancesâ€¦");

  // Reset UI
  totalUsdEl.textContent = "$0.00";
  totalBreakdownEl.textContent = "TON $0.00 â€¢ Jettons $0.00";
  tonBalEl.textContent = "0";
  tonUsdSubEl.textContent = "$0.00 (at $â€”/TON)";
  jetCountEl.textContent = "0";
  jetBody.innerHTML = `<tr><td colspan="4" class="muted">Fetching jettonsâ€¦</td></tr>`;

  try{
    // 1) TON balance + price
    const [tonBal, tonPriceUsd] = await Promise.all([
      getTonBalance(address),
      getTonPriceUSD()
    ]);
    const tonVal = (tonPriceUsd ? tonBal * tonPriceUsd : 0);

    tonBalEl.textContent = fmt(tonBal, 6);
    tonUsdSubEl.textContent = `$${fmt(tonVal,2)} (at $${fmt(tonPriceUsd, 4)}/TON)`;

    // 2) Jettons
    const jets = await getJettonBalances(address);
    jetCountEl.textContent = String(jets.length);

    // Fetch jetton prices sequentially with a small delay to be kind to APIs
    let pricedCount = 0;
    for (let i=0; i<jets.length; i++){
      const j = jets[i];
      if (j.balance <= 0){
        j.priceUsd = null;
        j.valueUsd = null;
      }else{
        const p = await getJettonPriceUSD(j.address, j.decimals); // pass decimals for accuracy
        j.priceUsd = (p && isFinite(p)) ? p : null;
        j.valueUsd = (j.priceUsd!=null) ? (j.balance * j.priceUsd) : null;
        if (j.priceUsd!=null) pricedCount++;
        await sleep(PRICE_FETCH_DELAY_MS);
      }
      if (i===0 || i%5===0 || i===jets.length-1){
        renderJettons(jets);
        notify(`Pricing jettonsâ€¦ ${i+1}/${jets.length}`);
      }
    }

    // 3) Totals
    const jetUsd = jets.reduce((s,x)=> s + (x.valueUsd || 0), 0);
    const total = tonVal + jetUsd;

    totalUsdEl.textContent = `$${fmt(total,2)}`;
    totalBreakdownEl.textContent = `TON $${fmt(tonVal,2)} â€¢ Jettons $${fmt(jetUsd,2)} (${pricedCount}/${jets.length} priced)`;
    notify("Done âœ”");
  }catch(err){
    console.error(err);
    notify("Error loading data. Check address and try again.", "bad");
    jetBody.innerHTML = `<tr><td colspan="4" class="warn">Failed to fetch balances.</td></tr>`;
  }
}

/** ==== Autofill on load: DEFAULT / ?addr= / saved ==== */
(function boot(){
  const fromQuery = getAddrFromQuery();
  const saved = getSavedAddr();
  const initial = fromQuery || saved || DEFAULT_ADDRESS;
  if (initial){ addrInput.value = initial; }
  if (initial){ loadAll(); }
})();
</script>
</body>
</html>
