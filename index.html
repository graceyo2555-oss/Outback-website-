<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TON Treasury Tracker</title>
<meta name="description" content="Simple TON wallet & treasury tracker for TON + Jettons." />
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'><text y='.9em' font-size='90'>üíé</text></svg>">

<style>
  :root{
    --bg:#0b1220; --card:#121a2b; --muted:#8aa0c4; --text:#e6eeff; --accent:#3ea6ff; --good:#00d084; --warn:#ffaa00; --bad:#ff5470; --border:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    color:var(--text); background: radial-gradient(1000px 600px at 20% -10%, #19305666, transparent 60%), radial-gradient(800px 500px at 100% 0%, #0e254566, transparent 60%), var(--bg);
  }
  .wrap{max-width:1100px; margin:0 auto; padding:28px 16px 56px}
  header{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:18px}
  h1{font-size:22px; font-weight:800; margin:0; letter-spacing:.2px}
  .tag{padding:4px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}

  .panel{background:var(--card); border:1px solid var(--border); border-radius:18px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .grid{display:grid; gap:12px}
  @media(min-width:900px){ .grid-3{grid-template-columns: 1.2fr .8fr 1fr} }
  @media(min-width:900px){ .grid-2{grid-template-columns: 1fr 1fr} }

  .controls{display:flex; gap:10px; flex-wrap:wrap}
  input[type="text"]{
    flex:1 1 280px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0f1627; color:var(--text);
    outline:none; transition:.2s border;
  }
  input[type="text"]::placeholder{color:#6f86ad}
  button{
    padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:#0f1627; color:var(--text); cursor:pointer; font-weight:700;
  }
  button.primary{background:linear-gradient(180deg, #1c7ed6, #1864ab); border:none}
  button.ghost{background:transparent}
  .note{color:var(--muted); font-size:12px}

  .kpi{display:flex; flex-direction:column; gap:6px; padding:14px; border:1px dashed var(--border); border-radius:14px}
  .kpi .label{color:var(--muted); font-size:12px}
  .kpi .value{font-size:22px; font-weight:800}
  .kpi .sub{color:var(--muted); font-size:12px}

  .table{width:100%; border-collapse:collapse; margin-top:6px; font-size:14px}
  .table th, .table td{padding:10px 8px; border-bottom:1px solid var(--border)}
  .table th{color:#93add1; font-weight:700; text-align:left; font-size:12px}
  .right{text-align:right}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  .pill{padding:2px 8px; border-radius:999px; background:#0d1a2b; border:1px solid var(--border); color:#a8c2ea; font-size:12px; display:inline-flex; align-items:center; gap:6px}
  .status{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}

  .footer{margin-top:18px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  a{color:var(--accent); text-decoration:none}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .warn{color:var(--warn)}
  .good{color:var(--good)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex; align-items:center; gap:10px">
        <h1>TON Treasury Tracker</h1>
        <span class="tag">alpha ‚Ä¢ client-side only</span>
      </div>
      <div class="status" id="status"><span>Ready.</span></div>
    </header>

    <div class="panel">
      <div class="controls">
        <input id="addr" type="text" spellcheck="false" placeholder="Enter TON wallet address (e.g. EQC...)" />
        <button class="ghost" id="pasteBtn">Paste</button>
        <button class="ghost" id="exampleBtn">Use Example</button>
        <button class="primary" id="loadBtn">Load</button>
      </div>
      <div class="note" style="margin-top:8px">
        Tip: Save this page and deploy on Vercel. You can also set <span class="mono">DEFAULT_ADDRESS</span> inside the code to prefill your treasury wallet.
      </div>
    </div>

    <div class="grid grid-3" style="margin-top:12px">
      <div class="panel">
        <div class="kpi">
          <div class="label">Total Portfolio Value</div>
          <div class="value" id="totalUsd">$0.00</div>
          <div class="sub" id="totalBreakdown">TON $0.00 ‚Ä¢ Jettons $0.00</div>
        </div>
      </div>
      <div class="panel">
        <div class="kpi">
          <div class="label">TON Balance</div>
          <div class="value" id="tonBal">0</div>
          <div class="sub" id="tonUsdSub">$0.00 (at $‚Äî/TON)</div>
        </div>
      </div>
      <div class="panel">
        <div class="kpi">
          <div class="label">Jettons Tracked</div>
          <div class="value" id="jetCount">0</div>
          <div class="sub">Priced via GeckoTerminal when available</div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap">
        <h2 style="font-size:16px; margin:0">Jettons</h2>
        <div class="pill"><span>Filter:</span>
          <select id="filterSel" style="background:transparent; color:#a8c2ea; border:none; outline:none">
            <option value="all">All</option>
            <option value="priced">With price</option>
            <option value="unpriced">No price</option>
            <option value="nonzero">Non-zero balance</option>
          </select>
        </div>
      </div>
      <table class="table" id="jetTable">
        <thead>
          <tr>
            <th>Token</th>
            <th class="right">Balance</th>
            <th class="right">Price (USD)</th>
            <th class="right">Value (USD)</th>
          </tr>
        </thead>
        <tbody id="jetBody">
          <tr><td colspan="4" class="muted">No data yet.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="footer">
      <div class="muted">Data from TonAPI & GeckoTerminal. Prices can be missing for illiquid/new tokens.</div>
      <div class="muted">Built with ‚ù§Ô∏è for TON.</div>
    </div>
  </div>

<script>
/** ================================
 *  BASIC SETTINGS (edit these)
 *  ================================ */
const DEFAULT_ADDRESS = ""; // ‚Üê put your treasury wallet here to prefill (e.g. "EQBDc5nG...")
const TONAPI_BASE = "https://tonapi.io";
const TON_DECIMALS = 9;

/** Rate limits & courtesy timeout between token price fetches */
const PRICE_FETCH_DELAY_MS = 120; // be gentle to APIs

/** Helpers */
const $ = (id)=>document.getElementById(id);
const fmt = (n, d=2) => {
  if (n === null || n === undefined || isNaN(n)) return "‚Äî";
  const v = Number(n);
  if (Math.abs(v) >= 1000000) return v.toLocaleString(undefined,{maximumFractionDigits:d});
  return v.toLocaleString(undefined,{minimumFractionDigits: (v>0 && v<1 ? Math.min(4,d+2):0), maximumFractionDigits:d});
};
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

/** UI elements */
const addrInput = $("addr");
const statusEl = $("status");
const totalUsdEl = $("totalUsd");
const totalBreakdownEl = $("totalBreakdown");
const tonBalEl = $("tonBal");
const tonUsdSubEl = $("tonUsdSub");
const jetCountEl = $("jetCount");
const jetBody = $("jetBody");
const filterSel = $("filterSel");

if (DEFAULT_ADDRESS) addrInput.value = DEFAULT_ADDRESS;

/** Event wiring */
$("pasteBtn").onclick = async ()=>{
  try{
    const t = await navigator.clipboard.readText();
    if (t) addrInput.value = t.trim();
  }catch(e){ notify("Clipboard blocked by browser.", "warn"); }
};
$("exampleBtn").onclick = ()=>{
  addrInput.value = "EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c"; // harmless dummy; replace with a real address
};
$("loadBtn").onclick = ()=> loadAll();
filterSel.onchange = ()=> applyFilter();

/** Notify helper */
function notify(msg, level=""){
  statusEl.innerHTML = `<span class="${level}">${msg}</span>`;
}

/** ==== API fetchers ==== */

/** Get TON (native) balance for account (in TON) */
async function getTonBalance(address){
  const url = `${TONAPI_BASE}/v2/accounts/${address}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`TonAPI account: ${r.status}`);
  const j = await r.json();
  const ton = (j.balance ?? 0) / (10 ** TON_DECIMALS);
  return ton;
}

/** Get Jetton balances (array) */
async function getJettonBalances(address){
  const url = `${TONAPI_BASE}/v2/accounts/${address}/jettons?limit=500`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`TonAPI jettons: ${r.status}`);
  const j = await r.json();
  // Normalize
  // TonAPI returns: balances: [{balance, jetton:{address, name, symbol, decimals, image, ...}}]
  const out = (j.balances || []).map(x=>{
    const d = x.jetton || {};
    const dec = Number(d.decimals ?? 9);
    return {
      address: (d.address || "").trim(),
      name: d.name || "Unknown",
      symbol: d.symbol || "???",
      decimals: dec,
      image: d.image,
      rawBalance: Number(x.balance || 0),
      balance: Number(x.balance || 0) / (10 ** dec),
      priceUsd: null,
      valueUsd: null
    };
  });
  return out;
}

/** Get USD price for a TON jetton via GeckoTerminal token endpoint */
async function getJettonPriceUSD(jettonAddress){
  // Docs-style endpoint (no key): https://api.geckoterminal.com/api/v2/networks/ton/tokens/{address}
  // Returns attributes.price_usd if known
  const url = `https://api.geckoterminal.com/api/v2/networks/ton/tokens/${encodeURIComponent(jettonAddress)}?include=top_pools`;
  const r = await fetch(url, {headers:{ "accept":"application/json" }});
  if (!r.ok) return null;
  const j = await r.json();
  const price = j?.data?.attributes?.price_usd;
  return price ? Number(price) : null;
}

/** Get USD price for native TON from CoinGecko (fallback if needed) */
async function getTonPriceUSD(){
  // Coingecko simple price; if it ever rate-limits, you can swap in GeckoTerminal network stats or another source.
  const url = `https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd`;
  const r = await fetch(url);
  if (!r.ok) return null;
  const j = await r.json();
  return Number(j?.["the-open-network"]?.usd ?? null);
}

/** ==== Renderers ==== */

function renderJettons(rows){
  if (!rows || rows.length===0){
    jetBody.innerHTML = `<tr><td colspan="4" class="muted">No jettons found for this wallet.</td></tr>`;
    return;
  }
  const html = rows.map(t=>{
    const img = t.image ? `<img src="${t.image}" alt="" style="width:18px;height:18px;border-radius:50%;vertical-align:-4px;margin-right:6px">` : "";
    const priceTxt = (t.priceUsd==null ? `<span class="muted">‚Äî</span>` : `$${fmt(t.priceUsd, 6)}`);
    const valTxt = (t.valueUsd==null ? `<span class="muted">‚Äî</span>` : `$${fmt(t.valueUsd, 2)}`);
    return `<tr data-priced="${t.priceUsd!=null}" data-nonzero="${t.balance>0}">
      <td>${img}<span class="mono" title="${t.address}">${t.symbol}</span> <span class="muted">¬∑ ${t.name}</span></td>
      <td class="right mono" title="${t.rawBalance} raw">${fmt(t.balance, 6)}</td>
      <td class="right">${priceTxt}</td>
      <td class="right">${valTxt}</td>
    </tr>`;
  }).join("");
  jetBody.innerHTML = html;
  applyFilter();
}

function applyFilter(){
  const mode = filterSel.value;
  [...jetBody.querySelectorAll("tr")].forEach(tr=>{
    let show = true;
    const priced = tr.getAttribute("data-priced")==="true";
    const nonzero = tr.getAttribute("data-nonzero")==="true";
    if (mode==="priced" && !priced) show=false;
    if (mode==="unpriced" && priced) show=false;
    if (mode==="nonzero" && !nonzero) show=false;
    tr.style.display = show ? "" : "none";
  });
}

/** ==== Controller ==== */

async function loadAll(){
  const address = addrInput.value.trim();
  if (!address || address.length < 10){
    notify("Enter a valid TON wallet address.", "warn");
    return;
  }
  notify("Loading balances‚Ä¶");

  // Reset UI
  totalUsdEl.textContent = "$0.00";
  totalBreakdownEl.textContent = "TON $0.00 ‚Ä¢ Jettons $0.00";
  tonBalEl.textContent = "0";
  tonUsdSubEl.textContent = "$0.00 (at $‚Äî/TON)";
  jetCountEl.textContent = "0";
  jetBody.innerHTML = `<tr><td colspan="4" class="muted">Fetching jettons‚Ä¶</td></tr>`;

  try{
    // 1) TON balance
    const [tonBal, tonPriceUsd] = await Promise.all([
      getTonBalance(address),
      getTonPriceUSD()
    ]);
    const tonVal = (tonPriceUsd ? tonBal * tonPriceUsd : 0);

    tonBalEl.textContent = fmt(tonBal, 6);
    tonUsdSubEl.textContent = `$${fmt(tonVal,2)} (at $${fmt(tonPriceUsd, 4)}/TON)`;

    // 2) Jettons
    const jets = await getJettonBalances(address);
    jetCountEl.textContent = String(jets.length);

    // Fetch jetton prices sequentially with a small delay to be kind to APIs
    let pricedCount = 0;
    for (let i=0; i<jets.length; i++){
      const j = jets[i];
      // skip zero balances to save calls
      if (j.balance <= 0){
        j.priceUsd = null;
        j.valueUsd = null;
      }else{
        const p = await getJettonPriceUSD(j.address);
        j.priceUsd = (p && isFinite(p)) ? p : null;
        j.valueUsd = (j.priceUsd!=null) ? (j.balance * j.priceUsd) : null;
        if (j.priceUsd!=null) pricedCount++;
        await sleep(PRICE_FETCH_DELAY_MS);
      }
      // Optionally render progressively every few items
      if (i===0 || i%5===0 || i===jets.length-1){
        renderJettons(jets);
        notify(`Pricing jettons‚Ä¶ ${i+1}/${jets.length}`);
      }
    }

    // 3) Totals
    const jetUsd = jets.reduce((s,x)=> s + (x.valueUsd || 0), 0);
    const total = tonVal + jetUsd;

    totalUsdEl.textContent = `$${fmt(total,2)}`;
    totalBreakdownEl.textContent = `TON $${fmt(tonVal,2)} ‚Ä¢ Jettons $${fmt(jetUsd,2)} (${pricedCount}/${jets.length} priced)`;
    notify("Done ‚úî");
  }catch(err){
    console.error(err);
    notify("Error loading data. Check address and try again.", "bad");
    jetBody.innerHTML = `<tr><td colspan="4" class="warn">Failed to fetch balances.</td></tr>`;
  }
}
</script>
</body>
</html>
